# Supabase Setup Guide

This guide will help you set up Supabase for your Pokemon Build application.

## Prerequisites

1. A Supabase account (sign up at https://supabase.com)
2. Node.js and npm installed

## Step 1: Create a Supabase Project

1. Go to [Supabase Dashboard](https://supabase.com/dashboard)
2. Click "New project"
3. Choose your organization and provide:
   - Project name: `pokemon-builds` (or your preferred name)
   - Database password: Create a strong password
   - Region: Choose the closest region to you
4. Click "Create new project"

## Step 2: Set Up the Database Schema

1. In your Supabase dashboard, go to the "SQL Editor"
2. Create a new query and run this SQL to create the pokemon_builds table with per-user scoping:

```sql
-- Ensure UUID generation available (usually enabled by default on Supabase)
create extension if not exists "pgcrypto";

-- Create the pokemon_builds table to match the app's expected fields
CREATE TABLE IF NOT EXISTS pokemon_builds (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  species TEXT NOT NULL,
  gender TEXT CHECK (gender IN ('M','F','U')),
  tier TEXT NOT NULL CHECK (tier IN ('OU', 'UU', 'NU', 'Doubles', 'UT', 'LC')),
  level INTEGER NOT NULL DEFAULT 50 CHECK (level >= 1 AND level <= 100),
  nature TEXT NOT NULL,
  ability TEXT NOT NULL,
  item TEXT,
  moves TEXT[] NOT NULL DEFAULT '{}',
  ivs JSONB NOT NULL DEFAULT '{
    "hp": 31,
    "attack": 31,
    "defense": 31,
    "sp_attack": 31,
    "sp_defense": 31,
    "speed": 31
  }',
  evs JSONB NOT NULL DEFAULT '{
    "hp": 0,
    "attack": 0,
    "defense": 0,
    "sp_attack": 0,
    "sp_defense": 0,
    "speed": 0
  }',
  description TEXT,
  showdown_import TEXT,
  team_id TEXT,
  team_name TEXT,
  user_id UUID NOT NULL DEFAULT auth.uid() REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Indexes for faster queries
CREATE INDEX IF NOT EXISTS idx_pokemon_builds_tier ON pokemon_builds(tier);
CREATE INDEX IF NOT EXISTS idx_pokemon_builds_user_id ON pokemon_builds(user_id);
CREATE INDEX IF NOT EXISTS idx_pokemon_builds_created_at ON pokemon_builds(created_at);
CREATE INDEX IF NOT EXISTS idx_pokemon_builds_team_id ON pokemon_builds(team_id);

-- updated_at trigger
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE 'plpgsql';

DROP TRIGGER IF EXISTS update_pokemon_builds_updated_at ON pokemon_builds;
CREATE TRIGGER update_pokemon_builds_updated_at
  BEFORE UPDATE ON pokemon_builds
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Enable Row Level Security (RLS)
ALTER TABLE pokemon_builds ENABLE ROW LEVEL SECURITY;

-- Per-user policies
DROP POLICY IF EXISTS "Users can view all pokemon builds" ON pokemon_builds;
CREATE POLICY "Users can view own builds" ON pokemon_builds
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own builds" ON pokemon_builds
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own builds" ON pokemon_builds
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own builds" ON pokemon_builds
  FOR DELETE USING (auth.uid() = user_id);
```

## Step 3: Configure Environment Variables

1. Create a `.env` file in your project root
2. Add your Supabase credentials:

```env
VITE_SUPABASE_URL=your-supabase-project-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

To find these values:
- Go to your Supabase project dashboard
- Click "Settings" → "API"
- Copy the "Project URL" and "anon public" key

## Step 4: (Optional) Shiny Hunt Tables

If you want to store shiny hunts per user, create similar tables and policies:

```sql
CREATE TABLE IF NOT EXISTS shiny_hunts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  pokemon_id INTEGER NOT NULL,
  pokemon_name TEXT NOT NULL,
  method TEXT NOT NULL,
  start_date TIMESTAMPTZ DEFAULT NOW(),
  phase_count INTEGER NOT NULL DEFAULT 1,
  total_encounters INTEGER NOT NULL DEFAULT 0,
  is_completed BOOLEAN NOT NULL DEFAULT false,
  notes TEXT,
  phase_pokemon JSONB,
  user_id UUID NOT NULL DEFAULT auth.uid() REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

ALTER TABLE shiny_hunts ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view own shiny hunts" ON shiny_hunts
  FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own shiny hunts" ON shiny_hunts
  FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own shiny hunts" ON shiny_hunts
  FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own shiny hunts" ON shiny_hunts
  FOR DELETE USING (auth.uid() = user_id);
```

## Step 5: Test Your Setup

1. Run your React application: `npm run dev`
2. Log in, navigate to the PVP page (`/pvp`)
3. Add a Pokemon build — it will be saved under your user and only visible to you

## Example Environment Variables

```env
# Replace with your actual Supabase project details
VITE_SUPABASE_URL=your-supabase-project-url
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key
```

## Troubleshooting

### Common Issues

1. **"Invalid API key" error**: Make sure your environment variables are correctly set and the `.env` file is in the project root.

2. **"Row Level Security policy violation"**: This happens if RLS is enabled but no policies allow the operation. Make sure the policies are created correctly.

3. **"Table doesn't exist"**: Run the SQL schema creation script in the Supabase SQL Editor.

### Debugging

1. Check the browser console for error messages
2. Check the Supabase dashboard logs under "Logs" → "Database"
3. Make sure your environment variables are loaded (check `process.env.VITE_SUPABASE_URL` in the browser console)

## Alternative: Using with Existing Backend

If you prefer to use your existing backend instead of Supabase:

1. Keep your current backend running
2. Update the `PokemonBuildService` in `app/services/supabase.ts` to use your backend endpoints
3. Remove the Supabase client import and use regular fetch calls

## Next Steps

Once your Supabase setup is complete, you can:
- Add user authentication
- Set up real-time subscriptions for live updates
- Add more advanced features like team building
- Deploy your app with automatic Supabase connection

For more detailed documentation, visit the [Supabase Documentation](https://supabase.com/docs). 